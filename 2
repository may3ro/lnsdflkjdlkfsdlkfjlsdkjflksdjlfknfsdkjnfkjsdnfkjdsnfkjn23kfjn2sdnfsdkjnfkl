# SonarQube Export Script for ABAP Code Security Review
# Exports issues with code snippets, rule details, and recommendations
# Author: [Your Name]
# Context: SAP ABAP Secure Code Assessment

# ===== CONFIGURATION =====
$SonarQubeUrl = "https://your-sonarqube-server"
$Token = "YOUR_TOKEN"
$ProjectKey = "your_project_key"
$OutputFile = "SonarQube_ABAP_Security_Report.csv"

# ===== AUTH & HEADERS =====
$Headers = @{
    "Authorization" = "Basic " + [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("$Token:"))
}

# ===== FUNCTIONS =====
function Get-SonarQubeIssues {
    param($ProjectKey)
    $PageSize = 500
    $Page = 1
    $AllIssues = @()

    do {
        $Url = "$SonarQubeUrl/api/issues/search?componentKeys=$ProjectKey&p=$Page&ps=$PageSize"
        $Response = Invoke-RestMethod -Uri $Url -Headers $Headers -Method Get
        $AllIssues += $Response.issues
        $Page++
    } while ($Response.paging.total -gt ($AllIssues.Count))

    return $AllIssues
}

function Get-RuleDetails {
    param($RuleKey)
    $RuleUrl = "$SonarQubeUrl/api/rules/show?key=$RuleKey"
    try {
        $RuleResponse = Invoke-RestMethod -Uri $RuleUrl -Headers $Headers -Method Get
        return $RuleResponse.rule
    } catch {
        return $null
    }
}

function Get-CodeSnippet {
    param($Component, $Line)
    $RawUrl = "$SonarQubeUrl/api/sources/raw?key=$Component"
    try {
        $Code = Invoke-RestMethod -Uri $RawUrl -Headers $Headers -Method Get
        $Lines = $Code -split "`n"
        $SnippetRange = (($Line - 3)..($Line + 3)) | Where-Object { $_ -gt 0 -and $_ -le $Lines.Count }
        return ($SnippetRange | ForEach-Object { "$_:`t" + $Lines[$_-1] }) -join "`n"
    } catch {
        return ""
    }
}

# ===== MAIN EXECUTION =====
$Issues = Get-SonarQubeIssues -ProjectKey $ProjectKey
$Results = @()

foreach ($Issue in $Issues) {
    $RuleDetails = Get-RuleDetails -RuleKey $Issue.rule
    $Snippet = Get-CodeSnippet -Component $Issue.component -Line $Issue.line

    $Results += [PSCustomObject]@{
        Project      = $ProjectKey
        File         = $Issue.component
        Line         = $Issue.line
        Type         = $Issue.type
        Severity     = $Issue.severity
        Rule         = $RuleDetails.name
        Description  = $RuleDetails.htmlDesc -replace '<[^>]+>', ''
        Recommendation = $RuleDetails.remediationFnBaseEffort -replace '<[^>]+>', ''
        Message      = $Issue.message
        CodeSnippet  = $Snippet
    }
}

$Results | Export-Csv -Path $OutputFile -NoTypeInformation -Encoding UTF8
Write-Host "Export completed: $OutputFile"
